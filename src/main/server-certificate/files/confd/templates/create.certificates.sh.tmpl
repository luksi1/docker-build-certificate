#!/bin/sh

mkdir -p /ssl/certs /ssl/crl /ssl/newcerts /ssl/private /ssl/csr /ssl/newcerts
chmod 700 /ssl/private
touch /ssl/index.txt
echo 1000 > /ssl/serial
echo 1000 > /ssl/crlnumber

# Create a server certificate key and certificate signing request
openssl req -nodes -newkey rsa:2048 -keyout /export/private/{{ getenv "SERVER_NAME" }}.key -out /ssl/csr/{{ getenv "SERVER_NAME" }}.csr -subj "{{ getenv "SERVER_SUBJECT" }}"
chmod 400 /export/private/{{ getenv "SERVER_NAME" }}.key

# Sign the certificate
openssl ca -batch -config /ssl/openssl.cnf \
  -extensions server_cert -days {{ getenv "SERVER_CERT_EXPIRATION_DAYS" }} -notext -md sha256 \
  -keyfile /export/private/intermediate.key \
  -key {{ getenv "INTERMEDIATE_KEY_PASSWORD" }} \
  -cert /export/certs/intermediate.crt \
  -in /ssl/csr/{{ getenv "SERVER_NAME" }}.csr \
  -out /export/certs/{{ getenv "SERVER_NAME" }}.crt

chmod 444 /export/certs/{{ getenv "SERVER_NAME" }}.crt

